name: platform-infra-deployment

on:
  push:
    branches:
      - main
      - staging
      - dev
  workflow_dispatch:

env:
  AWS_REGION: us-east-1
  TF_ROOT: 04-terraform/root

jobs:
  e2e-deploy:
    runs-on: ubuntu-latest
    environment:
      name: ${{ github.ref_name == 'main' && 'prod' || github.ref_name }}

    permissions:
      id-token: write
      contents: read

    steps:
      - name: Checkout Repo
        uses: actions/checkout@v4

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: 1.7.0

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Configure AWS credentials via OIDC
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_ROLE_ARN }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Select Terraform Workspace & env file
        id: envselect
        working-directory: ${{ env.TF_ROOT }}
        run: |
          if [ "${GITHUB_REF_NAME}" = "main" ]; then
            WS="prod"
            ENV_FILE="terraform.tfvars.prod"
          elif [ "${GITHUB_REF_NAME}" = "staging" ]; then
            WS="staging"
            ENV_FILE="terraform.tfvars.staging"
          else
            WS="dev"
            ENV_FILE="terraform.tfvars.dev"
          fi

          terraform workspace select "$WS" || terraform workspace new "$WS"

          echo "workspace=$WS" >> "$GITHUB_OUTPUT"
          echo "env_file=$ENV_FILE" >> "$GITHUB_OUTPUT"

      - name: Terraform Init
        run: terraform -chdir=${{ env.TF_ROOT }} init \
          -backend-config="key=${{ steps.envselect.outputs.workspace }}.tfstate"

      - name: Terraform Plan
        id: plan
        run: |
          terraform -chdir=${{ env.TF_ROOT }} plan \
            -out=tfplan \
            -var-file=${{ steps.envselect.outputs.env_file }}
          terraform -chdir=${{ env.TF_ROOT }} show tfplan

      - name: Run PostgreSQL Migrations
        if: ${{ steps.plan.outcome == 'success' }}
        run: python3 04-terraform/modules/rds_postgres/postgresql_migration.py
        env:
          DB_HOST: ${{ secrets.DB_HOST }}
          DB_NAME: ${{ secrets.DB_NAME }}
          DB_USER: ${{ secrets.DB_USER }}
          DB_PASSWORD: ${{ secrets.DB_PASSWORD }}

      - name: Run DynamoDB Migrations
        if: ${{ steps.plan.outcome == 'success' }}
        run: python3 04-terraform/modules/dynamodb_table/dynamodb_migration.py
        env:
          DYNAMODB_TABLE: ${{ secrets.DYNAMODB_TABLE }}
          REGION_NAME: ${{ env.AWS_REGION }}

      - name: Terraform Apply
        run: terraform -chdir=${{ env.TF_ROOT }} apply -auto-approve tfplan

      - name: ECS Service Health Check
        run: |
          CLUSTER=$(terraform -chdir=${{ env.TF_ROOT }} output -raw ecs_cluster_id)
          SERVICE=$(terraform -chdir=${{ env.TF_ROOT }} output -raw ecs_service_name)
          aws ecs wait services-stable --cluster "$CLUSTER" --services "$SERVICE"

          RUNNING=$(aws ecs describe-services \
            --cluster "$CLUSTER" \
            --services "$SERVICE" \
            --query "services[0].runningCount" \
            --output text)

          if [ "$RUNNING" -lt 1 ]; then
            echo "ECS service not running!"
            exit 1
          fi

      - name: Rollback ECS Service
        if: failure()
        run: |
          SERVICE_NAME=$(terraform -chdir=${{ env.TF_ROOT }} output -raw ecs_service_name)
          PREV_TASK_DEF=$(aws ecs list-task-definitions \
            --family-prefix "$SERVICE_NAME" \
            --sort DESC \
            --query "taskDefinitionArns[1]" \
            --output text)

          CLUSTER=$(terraform -chdir=${{ env.TF_ROOT }} output -raw ecs_cluster_id)
          SERVICE=$(terraform -chdir=${{ env.TF_ROOT }} output -raw ecs_service_name)

          echo "Rolling back service $SERVICE in cluster $CLUSTER to $PREV_TASK_DEF"
          aws ecs update-service \
            --cluster "$CLUSTER" \
            --service "$SERVICE" \
            --task-definition "$PREV_TASK_DEF"

      - name: Notify Deployment Result
        if: always()
        run: |
          STATUS="${{ job.status }}"
          echo "Deployment $STATUS"
          echo "Environment: ${{ steps.envselect.outputs.workspace }}"
          echo "ECS Service: $(terraform -chdir=${{ env.TF_ROOT }} output -raw ecs_service_name)"
          echo "RDS Endpoint: $(terraform -chdir=${{ env.TF_ROOT }} output -raw rds_endpoint)"
          echo "DynamoDB Table: $(terraform -chdir=${{ env.TF_ROOT }} output -raw dynamodb_table_name)"
          # Replace these echoes with Slack/Teams/email calls as needed
