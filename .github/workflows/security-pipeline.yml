name: Node.js Secure CI/CD Pipeline

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]
  workflow_dispatch:

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

permissions:
  contents: read

jobs:
  security-scanning:
    name: Dependency and Code Security Scanning
    runs-on: ubuntu-latest
    permissions:
      contents: read
      security-events: write
      actions: read
      pull-requests: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js 20 (LTS)
        uses: actions/setup-node@v6
        with:
          node-version: "20"
          cache: "npm"

      - name: Install dependencies
        run: npm ci

      - name: Dependency Review (GitHub built-in)
        uses: actions/dependency-review-action@v4
        continue-on-error: true
        
      - name: npm audit (high and critical only)
        run: npm audit --audit-level=high --production
        continue-on-error: true

      - name: Snyk Open Source - Vulnerabilities
        uses: snyk/actions/node@master
        continue-on-error: true
        env:
          SNYK_TOKEN: ${{ secrets.SNYK_TOKEN }}
        with:
          args: --severity-threshold=high --sarif-file-output=snyk-os.sarif

      - name: Upload Snyk Open Source SARIF
        if: always()
        uses: github/codeql-action/upload-sarif@407ffafae6a767df3e0230e3d5f7a5a2c7b37e3d
        with:
          sarif_file: snyk-os.sarif

      # - name: Initialize CodeQL (SAST)
      #   uses: github/codeql-action/init@407ffafae6a767df3e0230e3d5f7a5a2c7b37e3d
      #   with:
      #     languages: javascript-typescript
      #     queries: security-extended

      # - name: Perform CodeQL analysis
      #   uses: github/codeql-action/analyze@407ffafae6a767df3e0230e3d5f7a5a2c7b37e3d

  deploy-to-production:
    name: Deploy to Production
    runs-on: ubuntu-latest
    needs: security-scanning
    if: github.ref == 'refs/heads/main' && github.event_name != 'pull_request'

    environment:
      name: production
      url: https://my-app-url.com

    permissions:
      contents: read
      deployments: write

    steps:
      - name: Checkout code
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683

      - name: Setup Node.js
        uses: actions/setup-node@1e60e59c7a2086d3d41dd76d7edbc48b4328e2f7
        with:
          node-version: "20"

      - name: Install dependencies
        run: npm ci

      - name: Build application
        run: npm run build

      - name: Deploy to production
        env:
          AWS_ACCESS_KEY_ID:     ${{ secrets.AWS_ACCESS_KEY_ID }}
          AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
        run: |
          echo "Deploying to production..."
          # Replace with your actual deployment commands
          # Example: aws s3 sync ... or vercel deploy ... or ecs update-service ...

      - name: Deployment successful notification
        if: success()
        run: echo "Production deployment completed successfully"
