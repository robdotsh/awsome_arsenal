name: Lint and Scan Before Merging to Main

# Trigger the workflow on pull requests targeting the main branch
on:
  pull_request:
    branches:
      - main
    paths:
      - "**/*"

jobs:
  lint_and_security:
    runs-on: ubuntu-latest
    name: Lint and Security Scanning

    steps:
      # Step 1: Checkout Code from the repository
      - name: Checkout Code
        uses: actions/checkout@v2

      # Step 2: Set up Terraform (v1.14.0)
      - name: Set up Terraform (v1.14.0)
        uses: hashicorp/setup-terraform@v1
        with:
          terraform_version: "1.14.0"

      # Step 3: Lint Directory Structure
      - name: Lint Directory Structure
        run: |
          expected_dirs=(
            "01-docker/compose-example"
            "01-docker/dockerfile-example"
            "02-kubernetes/cert-manager"
            "02-kubernetes/cluster-autoscaler"
            "02-kubernetes/ingress"
            "02-kubernetes/jenkins"
            "02-kubernetes/open-policy-agent"
            "02-kubernetes/services"
            "03-ci-cd/github-actions"
            "03-ci-cd/gitlab-ci"
            "03-ci-cd/jenkins"
            "04-terraform/aws"
            "04-terraform/gcp"
            "04-terraform/modules"
            "05-ansible/inventory"
            "05-ansible/playbooks"
            "05-ansible/roles"
            "05-ansible/scripts"
            "06-monitoring/grafana"
            "06-monitoring/loki"
            "06-monitoring/prometheus"
            "07-sre/chaos-engineering"
            "07-sre/playbooks"
            "07-sre/slos"
            "08-golang/basics"
            "08-golang/sample-app"
            "09-secrets/akeyless"
            "09-secrets/vault"
            "10-artifacts/artifactory"
            "10-artifacts/docker"
            "10-artifacts/maven"
            "10-artifacts/nexus"
            "10-artifacts/npm"
          )
          for dir in "${expected_dirs[@]}"; do
            if [ ! -e "$dir" ]; then
              echo "Error: Missing directory or file: $dir."
              exit 1
            fi
          done
          echo "All required directories and files are present!"

      # Step 4: Format Terraform files with terraform fmt
      - name: Format Terraform Files
        run: |
          terraform fmt -recursive
          echo "Terraform files formatted successfully."

      # Step 5: Secret Scanning with TruffleHog
      - name: Secret Scanning with TruffleHog
        run: |
          pip install truffleHog
          trufflehog --json . > trufflehog_report.json
          if [ -s trufflehog_report.json ]; then
            echo "Secrets found in the repository!"
            cat trufflehog_report.json
            exit 1
          else
            echo "No secrets found in the repository."
          fi

      # Step 6: Install Trivy and Scan Docker Image for Vulnerabilities
      - name: Install Trivy and Scan Container Image
        run: |
          TRIVY_VERSION="0.25.0"
          curl -sfL https://github.com/aquasecurity/trivy/releases/download/v${TRIVY_VERSION}/trivy_${TRIVY_VERSION}_Linux-64bit.tar.gz | tar -xz
          sudo mv trivy /usr/local/bin/

          # Build Docker image
          echo "docker build -t awsome_arsenal -f 01-docker/dockerfile-example/Dockerfile .

          # Run Trivy scan
          trivy image --exit-code 1 --severity HIGH,CRITICAL awsome_arsenal
          "
          echo "Trivy scan completed successfully."

      # Step 7: Run Terraform Security Scan with tfsec
      - name: Terraform Security Scan with tfsec
        run: |
          TFSEC_VERSION="v1.28.14"
          curl -Lo tfsec https://github.com/aquasecurity/tfsec/releases/download/${TFSEC_VERSION}/tfsec-linux-amd64
          chmod +x tfsec
          sudo mv tfsec /usr/local/bin/

          # Run tfsec to check for Terraform security misconfigurations
          tfsec 04-terraform/aws
          echo "Terraform security scan completed successfully."

      # Step 8: Kubernetes Security Linting with kube-score
      - name: Kubernetes Security Linting
        run: |
          KSCORE_VERSION="1.1.0"
          curl -s -L https://github.com/zegl/kube-score/releases/download/v${KSCORE_VERSION}/kube-score_${KSCORE_VERSION}_linux_amd64.tar.gz -o kube-score_${KSCORE_VERSION}_linux_amd64.tar.gz
          if [ ! -s kube-score_${KSCORE_VERSION}_linux_amd64.tar.gz ]; then
            echo "Error: Failed to download kube-score. Exiting."
            exit 1
          fi

          # Extract and run kube-score linting
          tar -xzvf kube-score_${KSCORE_VERSION}_linux_amd64.tar.gz
          ./kube-score score 02-kubernetes/**/*.yaml | grep -v "The service is of type NodePort"
          echo "Kubernetes security linting completed successfully."

      # Step 9: Run Terraform Linting with tflint
      - name: Terraform Linting with tflint
        run: |
          TFLINT_VERSION="0.60.0"
          curl -s -L https://github.com/terraform-linters/tflint/releases/download/v${TFLINT_VERSION}/tflint_linux_amd64.zip -o tflint.zip
          unzip tflint.zip -d /usr/local/bin/
          chmod +x /usr/local/bin/tflint
          tflint --init
          tflint --chdir=04-terraform/aws
          echo "Terraform linting completed successfully."

      # Step 10: Dockerfile Linting with Hadolint
      - name: Dockerfile Linting with Hadolint
        run: |
          HADOLINT_VERSION="2.6.0"
          curl -s https://github.com/hadolint/hadolint/releases/download/v${HADOLINT_VERSION}/hadolint-Linux-x86_64 -o /usr/local/bin/hadolint
          chmod +x /usr/local/bin/hadolint
          hadolint 01-docker/dockerfile-example/Dockerfile
          echo "Dockerfile linting completed successfully."

      # Step 11: Observability - Install Prometheus and Grafana (for Local Test)
      - name: Install Prometheus and Grafana (Only for local test)
        run: |
          echo "Starting Prometheus and Grafana (for local test only)..."
          echo "# docker-compose -f docker-compose-monitoring.yml up -d"
          echo "Prometheus and Grafana started."

      # Final Step: Success Validation
      - name: Final Validation
        run: |
          echo "All production checks completed successfully!"
